<!DOCTYPE html>
<html>
<head>
    <title>PIT by jsPsych</title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
	<script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.3"></script>
	<script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.1"></script>
	<script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
	<script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.4"></script>
	<script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>
	<script src="https://unpkg.com/@jspsych/plugin-survey@1.0.1"></script>
	<script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
	
	<link rel="icon" href="sources/icon.png" type="image/png">
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
	<link href="css/custom.css" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="https://unpkg.com/@jspsych/plugin-survey@1.0.1/css/survey.css">
	
</head>
<body>
    <script>
		var correct = 0;
		var acc = 0;
		
		function downloadData(data, filename) {
            var blob =  new Blob(["\ufeff", data], { type: 'text/csv;charset=utf-8;' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }
		
		var jsPsych = initJsPsych({
			on_finish: function() {
				acc = correct / 80;
				console.log('正确率 = ', acc);

				// 获取实验数据
				var data = jsPsych.data.get().csv();

				// 获取编号
				var subjectID = jsPsych.data.get().values()[1].response.id;
				downloadData(data, subjectID + '.csv');
			}
		});

		//全屏模式
		var open_fullscreen = {   
			type: jsPsychFullscreen,   
			fullscreen_mode: true,
			message: '<p style="font: 16pt 微软雅黑; text-align: left; line-height: 1.6em">'+
			'<b>'+
			'测验将在一个「全屏页面」开始，为确保最佳效果，请你：<br/>'+
			'（1）在电脑上进行测验，并使用主流浏览器打开本网页<br/>'+
			'（Chrome、Edge、Firefox、Safari等，不要用IE）<br/>'+
			'（2）关掉电脑上其他正在运行的程序或将其最小化<br/>'+
			'（3）将手机调至静音，并尽可能减少环境噪音干扰<br/>'+
			'（4）在测验过程中不要退出全屏<br/>'+
			'（5）务必认真作答<br/><br/>'+
			'</b>'+
			'如果你同意参与，并且清楚理解了上述要求，请点击开始：'+
			'</p>',

			button_label: '点击这里全屏开始',
			delay_after: 100
		}

		
	
		//获取随机数
		function getRandomInteger(min, max) {
		  return Math.floor(Math.random() * (max - min + 1)) + min;
		}
		
	 	// 录入个人信息
		var survey= {
            type: jsPsychSurvey,
            survey_json: {
                showQuestionNumbers: false,
                elements: [
                    {
                        name: "id",
                        type: "text",
                        title: "编号",
                        inputType: "number",
                        min: 0,
                        max: 300,
                        defaultValue: 0,
                        isRequired: true
                    },
                    {
                        type: 'text',
                        title: '姓名',
                        name: 'name',
                        isRequired: true
                    },
                    {
                        type: 'radiogroup',
                        title: "性别",
                        name: 'sex',
                        choices: ['男', '女'],
                        isRequired: true
                    },
					{
                        name: "age",
                        type: "text",
                        title: "年龄",
                        inputType: "number",
                        min: 0,
                        max: 100,
                        defaultValue: null,
                        isRequired: true
                    },
                    {
                        type: 'text',
                        name: 'tel',
                        title: '手机号',
                        inputType: 'tel',
                        validators: [{
                            type: 'regex',
                            regex: '[0-9]{11}',
                            text: '请输入正确的手机号'
                        }],
                        isRequired: true
                    },
                    {
                        type: 'dropdown',
                        title: "学历",
                        name: 'education',
                        description: "目前获得的最高学历",
                        choices: ['小学', '初中', '高中', '本科', '研究生', '博士'],
                        showOtherItem: false,
                        showNoneItem: false,
                        isRequired: true
                    }
                ],
				completeText: '完成'
            }
        };

		
		
		//练习部分
		//指导语呈现
		var introimg = ['intro2.png', 'intro3.png', 'intro4.png'];
		var jewels = ['image1.png','image2.png','image3.png','image4.png','image5.png','image6.png','image7.png','image8.png'];
		jewels = jsPsych.randomization.shuffle(jewels);
		var instruct = {
			type: jsPsychInstructions,
			pages: [
			'<img src="sources/' + introimg[0] + '">',
			' <div class="jewel-container">'+
				'<div class="image-item"><img src="sources/' + jewels[0] + '" alt="Image 1"></div>'+
				'<div class="image-item"><img src="sources/' + jewels[1] + '" alt="Image 2"></div>'+
				'<div class="image-item"><img src="sources/' + jewels[2] + '" alt="Image 3"></div>'+
				'<div class="image-item"><img src="sources/' + jewels[3] + '" alt="Image 4"></div>'+
				'<div class="image-item"><img src="sources/' + jewels[4] + '" alt="Image 5"></div>'+
				'<div class="image-item"><img src="sources/' + jewels[5] + '" alt="Image 6"></div>'+
				'<div class="image-item"><img src="sources/' + jewels[6] + '" alt="Image 7"></div>'+
				'<div class="image-item"><img src="sources/' + jewels[7] + '" alt="Image 8"></div>'+
			'</div>',
			'<img src="sources/' + introimg[1] + '">'
			],
			button_label_next: "继续",
			button_label_previous: "返回",
			//指导语呈现完毕，鼠标消失
			on_finish: function () {
				var bodyNode = document.getElementsByTagName("body");
				for (let i = 0; i < bodyNode.length; i++) {
					bodyNode[i].style.cursor = "none";
				}
			},
			show_clickable_nav: true
		}
		
		
		var confirm = {
			type: jsPsychHtmlKeyboardResponse,
			stimulus:'<img src="sources/' + introimg[2] + '">',
			choices: [' ']
		}
		
		var start = {
			type: jsPsychHtmlKeyboardResponse,
			stimulus: '<img src = "sources/intro11.png">',
			choices: 'NO_KEYS',
			trial_duration: 2000
		};
		
		
		// 定义反馈函数
		var final_score = 100;
		function getFeedback(label, response) {
			var win_c = [
				{feedback: '<img src = "sources/rew.png">', probability: 0.8, score: 10},
				{feedback: '<img src = "sources/neutral.png">', probability: 0.2, score: 0}
			];
			
			var win_unc = [
				{feedback: '<img src = "sources/neutral.png">', probability: 0.8, score: 0},
				{feedback: '<img src = "sources/rew.png">', probability: 0.2, score: 10}
			];
			
			var avoid_c = [
				{feedback: '<img src = "sources/neutral.png">', probability: 0.8, score: 0},
				{feedback: '<img src = "sources/pun.png">', probability: 0.2, score: -10}
			];
			
			var avoid_unc = [
				{feedback: '<img src = "sources/pun.png">', probability: 0.8, score: -10},
				{feedback: '<img src = "sources/neutral.png">', probability: 0.2, score: 0}
			];

			var cumulativeProbability = 0;
			var randomValue = Math.random();

			if (label.includes('W')){
				if ((response == null && label.includes('N')) || (response == 'arrowleft' && label.includes('L')) || (response == 'arrowright' && label.includes('R'))){
					fb = win_c;
					correct++;
				}else fb = win_unc;
			}else {
				if ((response == null && label.includes('N')) || (response == 'arrowleft' && label.includes('L')) || (response == 'arrowright' && label.includes('R'))){
					fb = avoid_c;
					correct++;
				}else fb = avoid_unc;
			}
				
			for (var i = 0; i < fb.length; i++) {
				cumulativeProbability += fb[i].probability;
				if (randomValue < cumulativeProbability) {
					final_score += fb[i].score;
				  return fb[i].feedback;
				}
			}			
		}		

		// 定义主实验
		var block = [];
		var rep = 5;
		var stimu = [
			{st: '<img src = "sources/win1.png">', label:'W-G-L'},
			{st: '<img src = "sources/win2.png">', label:'W-G_R'},
			{st: '<img src = "sources/win3.png">', label:'W-N'},
			{st: '<img src = "sources/win4.png">', label:'W-N'},
			{st: '<img src = "sources/loss1.png">', label:'A-G-L'},
			{st: '<img src = "sources/loss2.png">', label:'A-G-R'},
			{st: '<img src = "sources/loss3.png">', label:'A-N'},
			{st: '<img src = "sources/loss4.png">', label:'A-N'}
		];
		var fixation = 'sources/resize注视点.png';
		for(var t=0; t< rep; t++){
			for(var i=0; i<stimu.length; i++){
				var trial = [];
				// 展示刺激
				trial.push({
					type: jsPsychHtmlKeyboardResponse,
					stimulus: stimu[i].st,
					trial_duration: 1300,
					choices: ['arrowleft', 'arrowright'],
					data: {label:stimu[i].label}
				});
				//注视点
				trial.push({
					type: jsPsychHtmlKeyboardResponse,
					stimulus: '<img src = "' + fixation + '">',
					trial_duration: getRandomInteger(1400, 2600),
					choices: 'NO_KEYS'
				});
				//反馈
				trial.push({
					type: jsPsychHtmlKeyboardResponse,
					stimulus:  function() {
						var last_data = jsPsych.data.get().last(2).values()[0];
						return getFeedback(last_data.label, last_data.response);
					 },
					trial_duration:750,
					choices: 'NO_KEYS'
				});
				//注视点 ITI
				trial.push({
					type: jsPsychHtmlKeyboardResponse,
					stimulus: '<img src = "' + fixation + '">',
					trial_duration:getRandomInteger(1250, 2000),
					choices: 'NO_KEYS'
				});
				block.push({
					timeline: trial
				});
			};
		};
		block = jsPsych.randomization.shuffle(block)
	
		
		var rest = {
            type: jsPsychSurveyLikert,
            questions: [
                {prompt: '休息时间。你想要休息多久？', labels: ['10秒', '30秒', '1分钟', '1分30秒', '2分钟'], required: true}
            ],
			//选择休息时间，鼠标出现
			on_start: function () {
				var bodyNode = document.getElementsByTagName("body");
				for (let i = 0; i < bodyNode.length; i++) {
					bodyNode[i].style.cursor = "default";
				}
			},
			scale_width: 500,
			button_label: '继续'
        };
		
		
		// 倒计时函数
        function startCountdown(duration, display) {
            var timer = duration, minutes, seconds;
            var interval = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = minutes + " : " + seconds;

                if (--timer < 0) {
                    clearInterval(interval);
                }
            }, 1000);
        }
		
        // 休息倒计时
        var countdown_trial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div class="countdown-container"><div id="countdown-timer" class="countdown-timer">-- : --</div><div class="countdown-message">请按任意键继续...</div></div>',
            choices: 'ALL_KEYS',
            on_load: function() {
                // 开始倒计时
				var resp = jsPsych.data.get().last(1).values()[0].response.Q0;
                switch (resp) {
					case 0: var clock = 10;break;
					case 1: var clock = 30;break;
					case 2: var clock = 60;break;
					case 3: var clock = 90;break;
					case 4: var clock = 120;break;
					default: var clock=60;
				} 
                var display = document.querySelector('#countdown-timer');
                startCountdown(clock, display);
            },
			//休息结束，鼠标消失
			on_finish: function () {
				var bodyNode = document.getElementsByTagName("body");
				for (let i = 0; i < bodyNode.length; i++) {
					bodyNode[i].style.cursor = "none";
				}
			}
        };

		
		// 进行第二个block
		var block2 = jsPsych.randomization.shuffle(block)
		
		
		// 迁移部分说明
		var trans_intro = {
			type: jsPsychHtmlKeyboardResponse,
			stimulus:'<img src="sources/trans.png">',
			choices: [' ']
		}
		
		//迁移试次
		var trans_line = [];
		for (var i=1; i<=48; i++){
			var trans = {
				type: jsPsychHtmlKeyboardResponse,
				stimulus: '<img src="sources/幻灯片' + i + '.PNG">',
				choices: ['arrowup', 'arrowdown'],
			}
			trans_line.push(trans);
		}
		trans_line = jsPsych.randomization.shuffle(trans_line);

		
		//水平移动动画
		var animation_trial = {
			type: jsPsychHtmlKeyboardResponse,
			stimulus: function() {
				return '<div id="animation-container" style="width: 100px; height: 100px; background-color: red;"></div>';
			},
			choices: "NO_KEYS",
			trial_duration: 2000, // 动画持续时间 (ms)
			on_load: function() {
				var container = document.getElementById('animation-container');
				var start = null;
				function step(timestamp) {
					if (!start) start = timestamp;
					var progress = timestamp - start;
					container.style.transform = 'translateY(-' + Math.min(progress / 10, 100) + 'px)';
					if (progress < 2000) {
						window.requestAnimationFrame(step);
					}
				}
				window.requestAnimationFrame(step);
			},
			on_finish: function() {
				jsPsych.data.displayData('json');
			}
		};
		
		//最终积分
        var show_score_trial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function() {
                return '<div class="container">' +
                    '<div class="title">实验结束</div>' +
                    '<div class="score">你的积分: ' + final_score + '</div>' +
                    '<div class="message">感谢你的参与！</div>' +
                    '</div>';
            },
            choices: 'k'
			//trial_duration: 3000
        };
		
		//退出全屏模式
		var quitFullscreenMode = {
			type: jsPsychFullscreen,
			fullscreen_mode: false,
			//全部结束，鼠标出现
			on_finish: function () {
				var bodyNode = document.getElementsByTagName("body");
				for (let i = 0; i < bodyNode.length; i++) {
					bodyNode[i].style.cursor = "default";
				}
			}
		};
		
		
		
		// 创建实验时间轴
		var timeline = [];
		
		// 进入全屏模式
		timeline.push(open_fullscreen);
		
		// 录入个人信息
		timeline.push(survey);
		
		// 指导语
		timeline.push(instruct);
		timeline.push(confirm);
		
		// 开始界面
		timeline.push(start);
		
		// 第一个block
		timeline.push({timeline: block});
		
		// 休息时间选择并倒计时
		timeline.push(rest);
		timeline.push(countdown_trial);
		
		// 第二个block
		timeline.push({timeline: block2});
		
		// 迁移部分
		timeline.push(trans_intro);
		timeline.push({timeline: trans_line});
		
		//timeline.push(animation_trial);
		
		// 展示积分
		timeline.push(show_score_trial);
		
		// 推出全屏
		timeline.push(quitFullscreenMode)
		
		// 初始化并启动实验
		jsPsych.run(timeline);

    </script>
</body>
</html>
