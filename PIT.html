<!DOCTYPE html>
<html>
<head>
    <title>jsPsych Example</title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
	<script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.3"></script>
	<script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.1"></script>
	<style>
		body {
		  background-color: #A6A6A6; /* 设置全局背景颜色 */
		}
		/*设置图片适应屏幕*/
		img {
		  max-width: 100%;
		  height: auto;
		}
  </style>
</head>
<body>
    <script>
		//获取随机数
		function getRandomInteger(min, max) {
		  return Math.floor(Math.random() * (max - min + 1)) + min;
		}
		
		var jsPsych = initJsPsych({
			//timeline: timeline,
			on_finish: function() {
				jsPsych.data.displayData('csv');
			}
		});
        // 创建实验时间轴
        var timeline = [];

		//全屏模式
        var open_fullscreen = {   
			type: jsPsychFullscreen,   
			fullscreen_mode: true,
			message: '<p style="font: 16pt 微软雅黑; text-align: left; line-height: 1.6em">'+
			'<b>'+
			'测验将在一个「全屏页面」开始，为确保最佳效果，请你：<br/>'+
			'（1）在电脑上进行测验，并使用主流浏览器打开本网页<br/>'+
			'（Chrome、Edge、Firefox、Safari等，不要用IE）<br/>'+
			'（2）关掉电脑上其他正在运行的程序或将其最小化<br/>'+
			'（3）将手机调至静音，并尽可能减少环境噪音干扰<br/>'+
			'（4）在测验过程中不要退出全屏<br/>'+
			'（5）务必认真作答<br/><br/>'+
			'</b>'+
			'如果你同意参与，并且清楚理解了上述要求，请点击开始：'+
			'</p>',

			button_label: '点击这里全屏开始',
			delay_after: 100

		}

		timeline.push(open_fullscreen);
		
		//练习部分
		//指导语呈现
		var introimg = ['intro2.png', 'intro3.png', 'intro4.png'];
		var test_prac_instr = [];
		for(var i=0; i<introimg.length; i++){
			test_prac_instr.push({
				type: jsPsychHtmlKeyboardResponse,
				stimulus:'<img src="sources/' + introimg[i] + '">',
				choices: [' ']
			});
		}
		timeline.push({
			timeline:test_prac_instr
		});
		
		var start = {
			type: jsPsychHtmlKeyboardResponse,
            stimulus: '<img src = "sources/intro11.png">',
			choices: 'NO_KEYS',
			trial_duration: 2000
		};
		timeline.push(start);
		
		 // 定义反馈函数
		function getFeedback() {
			var feedbackOptions = [
				{feedback: 'Great job!', probability: 0.5},
				{feedback: 'Well done!', probability: 0.3},
				{feedback: 'Keep going!', probability: 0.2}
			];

			var cumulativeProbability = 0;
			var randomValue = Math.random();

			for (var i = 0; i < feedbackOptions.length; i++) {
				cumulativeProbability += feedbackOptions[i].probability;
				if (randomValue < cumulativeProbability) {
				  return feedbackOptions[i].feedback;
				}
			}
		}

        // 定义主实验
        var block = [];
		var trial = [[]];
		var rep = 5;
		var stimu = [1,2,4,3];
		var fixation = 'sources/resize注视点.png';
		for(var t=0; t< rep; t++){
			var base = t*stimu.length;
			for(var i=0; i<stimu.length; i++){
				trial.push([]);
				var n=base+i;
				// 展示刺激
				trial[n].push({
					type: jsPsychHtmlKeyboardResponse,
					stimulus: '<img src = "source/' + stimu[i] + '">',
					trial_duration: 1300,
					choices: ['arrowleft', 'arrowright']
				});
				//注视点
				trial[n].push({
					type: jsPsychHtmlKeyboardResponse,
					stimulus: '<img src = "' + fixation + '">',
					trial_duration: getRandomInteger(1400, 2600),
					choices: 'NO_KEYS'
				});
				//反馈
				trial[n].push({
					type: jsPsychHtmlKeyboardResponse,
					stimulus:  function() {
						var last_response = jsPsych.data.get().last(1).values()[0].response;
						if (last_response === 'arrowleft') {
						  return getFeedback();
						} else if (last_response === 'arrowright') {
						  return getFeedback();
						} else {
						  return getFeedback();
						}
					 },
					trial_duration:750,
					choices: 'NO_KEYS'
				});
				//注视点 ITI
				trial[n].push({
					type: jsPsychHtmlKeyboardResponse,
					stimulus: '<img src = "' + fixation + '">',
					trial_duration:getRandomInteger(1250, 2000),
					choices: 'NO_KEYS'
				});
				block.push(trial[n]);
			};
		};
        timeline.push({
			timeline: jsPsych.randomization.shuffle(block),
			repeatitions: 3
		});
		
		var judgment_trials = {
			type: jsPsychImageKeyboardResponse,
			prompt: '<p>Press a number 1-7 to indicate how unusual the image is.</p>',
			choices: ['1','2','3','4','5','6','7'],
			timeline: [
				{stimulus: 'image1.png'},
				{stimulus: 'image2.png', prompt: '<p>Press 1 for this trial.</p>'},
				{stimulus: 'image3.png'}
			]
		}
		timeline.push(judgment_trials);
		
		//水平移动动画
		var animation_trial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function() {
                return '<div id="animation-container" style="width: 100px; height: 100px; background-color: red;"></div>';
            },
            choices: "NO_KEYS",
            trial_duration: 2000, // 动画持续时间 (ms)
            on_load: function() {
                var container = document.getElementById('animation-container');
                var start = null;
                function step(timestamp) {
                    if (!start) start = timestamp;
                    var progress = timestamp - start;
                    container.style.transform = 'translateY(-' + Math.min(progress / 10, 100) + 'px)';
                    if (progress < 2000) {
                        window.requestAnimationFrame(step);
                    }
                }
                window.requestAnimationFrame(step);
            },
            on_finish: function() {
                jsPsych.data.displayData('json');
            }
        };
		timeline.push(animation_trial);
		

		//结束指导语
		var end_intro = {
			type: jsPsychHtmlKeyboardResponse,
			stimulus: '<p style="font: bold 32pt 微软雅黑; color: #B22222">'+
			'实验结束，感谢您的参与！</p>'+
			'<p style="font: 20pt 微软雅黑; color: black"><br/>'+
			'<按任意格键退出全屏模式></p>'+
			'</p>',
			choices: 'ALL_KEYS',
			post_trial_gap: 100
		}
		timeline.push(end_intro)
		
		//退出全屏模式
		var quitFullscreenMode = {
			type: jsPsychFullscreen,
			fullscreen_mode: false,
			on_finish: function () {
				var bodyNode = document.getElementsByTagName("body");
				for (let i = 0; i < bodyNode.length; i++) {
					bodyNode[i].style.cursor = "none";
				}
			}
		};
		timeline.push(quitFullscreenMode)
		
        // 初始化并启动实验
		jsPsych.run(timeline);
    </script>
</body>
</html>
